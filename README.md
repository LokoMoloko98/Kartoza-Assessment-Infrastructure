# Kartoza Assessment Infrastructure

This repository contains Terraform configuration files to that provision and deploy Moloko Mokubedi's Kartoza technical assessment submission in an AWS Cloud environment. The setup includes the creation of a Virtual Private Cloud (VPC) with a public subnet, an IAM instance role with least-privilege permissions, and an EC2 instance launched within the VPC. The EC2 instance is configured with a user data script that does various bootstrapping tasks including updating the VM, installing Docker, managing instance name, making Route53 (DNS) changes, and deploying the web app.

## Features

1. **VPC Creation**: Sets up a Virtual Private Cloud (VPC) with a public subnet, including the necessary networking infrastructure such as route tables and internet gateway.

2. **Instance Role Creation**: Defines an instance role with permissions tailored for development tasks, including the ability to change instance names, make Route53 changes, and manage EC2 instances through Systems Manager (SSM).

3. **EC2 Instance Provisioning**: Launches an EC2 instance within the VPC and associates the networking infrastructure. The instance is configured with the previously created instance role.

4. **User Data Script**:
    - Updates the VM and downloads Docker.
    - Names the EC2 instance.
    - Creates an A record in Route53 and links it to the instance.
    - Clones the [Kartoza_Tech_Assessment](https://github.com/LokoMoloko98/Kartoza_Tech_Assessment) repository from your GitHub account.
    - Builds and runs the Docker container.

## Usage

### 1. Clone this repository to your local machine:
```bash
git clone https://github.com/LokoMoloko98/Kartoza-Assessment-Infrastructure
```

### 2. Navigate to the directory:
```
cd Kartoza-Assessment-Infrastructure
```

### 3. Modify the backend.tf file with your AWS profile and needed S3 remote-backend configurations to integrate the IaC config with your AWS environment.

N.B: These AWS resources have to be created manually via the AWS console before provisioning the IaC stack.

``` 
terraform {
  backend "s3" {
    bucket         = "Provide the name of the S3 bucket name that will hold the statefile"
    key            = "Provide the path to save the state file"
    region         = "Provide the AWS region code where the remote bucket is located"
    profile        = "Provide you currently logged awscli profile. Use aws access and secret keys if the awscli is not configured on your machine. THIS IS NOT RECOMMENDED. Using the awscli is best practice."
    dynamodb_table = "Provide the name of the DynamoDB table that holds the state lock hash.
":  }
}
```

### 4. Initialize the backend for state management of your Terraform config and dounload the AWS provider plugin by running this command.
```
terraform init
```
If any errors return check for any misconfigurations in the terraform resource in the backend.tf file and try reinitializing again.

### 5. Validate the terraform configuration files to ensure that they are free of syntax and dependency errors.

```
terraform validate
```

### 6. Review the infrastructure to be provisioned by seeing the terraform plan:
```
terraform plan
```

### 7. If you are satisfied with the plan, go ahead and provision the infrastructure:
```
terraform apply --auto-approve
```
You will be asked for the Route53 registered domain name and associated Route53 Hosted Zone ID that you want to serve the web app from. These 2 resources are important for the Traefik reverse proxy to identify the fqdn to register a LetsEncrypt SSL certificate for.  

###8. Che

### **Troubleshooting Connection Issues**: 
If the connection is not successful, you may need to modify the security group associated with the EC2 instance to allow SSH access. Ensure that port 22 is open for inbound traffic from your IP address. Additionally, double-check the SSH configuration file generated by Terraform to ensure that the correct hostname, user, and identity file are specified.
